# AGENTS.md

This file provides guidance to AI agents when working with code in this repository.

## Project Architecture

**Full-Stack HONC App** built on Cloudflare Workers with GitHub OAuth authentication using Better Auth.

### Core Applications

- **Frontend** (React 19 SPA): TypeScript frontend with Better Auth client, Vite build system, and responsive CSS styling
- **Backend** (Cloudflare Worker): Hono framework with Better Auth routing and middleware, D1 sqlite database, OpenAPI documentation

### Key Technologies

- **Runtime**: Cloudflare Workers with Hono framework
- **Database**: D1 (SQLite) with Drizzle ORM
- **Authentication**: Better Auth with GitHub OAuth
- **Frontend**: React 19 + TypeScript + Vite
- **API**: OpenAPI with Zod validation and Fiberplane explorer
- **Testing**: Vitest with Cloudflare Workers pool
- **Code Quality**: Biome for formatting and linting

## Setup commands

Package manager: **pnpm**

```bash
# Setup
pnpm install              # Install all dependencies
pnpm auth:generate        # Generate Better Auth schema (if changes to auth)
pnpm db:setup             # Set up local database

# Development
pnpm dev                  # Start frontend dev server
pnpm worker:dev           # Start worker dev server (separate terminal)

# Database
pnpm db:generate          # Generate migrations from schema changes
pnpm db:migrate           # Apply migrations to local database
pnpm db:studio            # Open Drizzle Studio (database GUI)

# Testing & Quality
pnpm worker:test          # Run API tests
pnpm format               # Format code with Biome
pnpm lint                 # Lint and fix code

# Deployment
pnpm deploy               # Build and deploy to Cloudflare
```

## Code Architecture Patterns

1. **Authentication-First**: All API routes except auth endpoints require GitHub OAuth authentication
2. **Type-Safe APIs**: Zod schemas with OpenAPI integration for validation and documentation
3. **Edge-Optimized**: Cloudflare Workers with D1 database for global performance
4. **Full-Stack TypeScript**: Shared types between frontend and backend

## Database & Storage

- **Database**: D1 with Drizzle ORM, migrations in `worker/drizzle/migrations/`
- **Schema**: Application tables in `worker/src/db/schema.ts`, auth tables auto-generated by Better Auth
- **Configuration**: `drizzle.config.ts` for local and production database connections
- **Environment**: `.dev.vars` files for local development (copy from samples in README)

## Development Workflow

1. Run `pnpm install` from root
2. Set up `.dev.vars` files from README examples
3. Generate auth schema with `pnpm auth:generate`
4. Set up database with `pnpm db:setup`
5. Start frontend with `pnpm dev` and worker with `pnpm worker:dev`
6. Use `pnpm db:studio` for database management
7. Deploy with `pnpm deploy`

## Important Notes

### Authentication System
- All API routes except auth endpoints require GitHub OAuth authentication
- Users must sign in via GitHub to access the application
- Session management handled automatically by Better Auth
- User access controlled via allowlist in `worker/src/utils/allow-list.ts`

### Key Files to Understand
- **`worker/src/lib/auth.ts`** - Better Auth server configuration
- **`worker/src/middleware/auth.ts`** - Authentication middleware
- **`src/lib/auth.ts`** - Better Auth React client
- **`src/components/Navigation.tsx`** - Auth UI component
- **`.dev.vars`** - Environment variables (not committed to repo)

### Common Issues
- Ensure `.dev.vars` has valid GitHub OAuth credentials
- Auth routes must bypass auth middleware (handled in `worker/src/index.ts`)
- Client and server auth configurations must match base URLs
- Database must include auth tables (generated via `pnpm auth:generate`)

## Code style

- Use `pnpm worker:test` to run API tests (not just `pnpm test`)
- Always validate database data exists before processing to prevent race conditions
- Use TypeScript strict mode and avoid `any` types for better type safety
- Follow Better Auth patterns for authentication middleware and session management
- Test authentication flows thoroughly as they involve external GitHub OAuth

## Coding Guidance

- Refrain from trying to read the entirety of worker-configuration.d.ts. These files are large and blow up your context window. Instead grep them or read them piece by piece

- To run tests use "pnpm test run" with the run suffix added as the "vitest run" command which will run test once and exit

- In vitest if you need to check if something is defined and you're then planning to check any further things there - use assert() call from vitest as opposed to expect(<thing>).toBeDefined(). This will prevent any type errors

- You should almost never add Cloudflare Bindings directly as a type. First see if they can be generated from the .dev.vars or the wrangler configuration file
